var existing_booking_i=0,att_bookings=[],lang_select_room_buddy=$(".lang_select_room_buddy").val();function hotel_reservation_init(){var e=[],t=(parseInt($(".partial-data-counter").val()),"True"==$(".force_default_dates_checker").val()),i=($(".require_room_selection_checker").val(),$(".require_room_buddy_checker").val(),"True"==$(".force_hotel_room_selection_checker").val());parseInt($(".week_start_day").val()),$(".kendo_language_select").val(),$(".default_date_format").val(),$(".lang_no_data_found").val();$(".form-plugin-hotel-reservation").each(function(){i="True"==$(this).find(".force_hotel_room_selection_checker").val();var o=1;if(i){t="True"==$(this).find(".force_default_dates_checker").val(),e=JSON.parse($(this).find(".hrp-available-dates").val());var a,l,n=$(this).find(".hotel-check-in0").val(),s=$(this).find(".hotel-check-out0").val();if(n.length<1&&(n="2017-01-01"),s.length<1&&(s="2017-01-01"),t)(a=$(this).find(".hotel-check-in0").pickadate().pickadate("picker")).set("select",new Date(n)),a.stop(),$(this).find(".hotel-check-in0").attr("readonly",!0),(l=$(this).find(".hotel-check-out0").pickadate().pickadate("picker")).set("select",new Date(s)),l.stop(),$(this).find(".hotel-check-out0").attr("readonly",!0);else{var r=strdate_list_to_dateList(e),d=new Date(n);if(n=d.getFullYear()+"-"+("0"+(d.getMonth()+1)).slice(-2)+"-"+("0"+d.getDate()).slice(-2),-1==$.inArray(n,e)&&(n=get_closest_date(d,e),d>new Date(n)&&(n=e[e.indexOf(n)-1])),console.log(n),(a=$(this).find(".hotel-check-in0").pickadate().pickadate("picker")).set("disable",r),a.set("disable","flip"),a.set("select",new Date(n)),s=(d=new Date(s)).getFullYear()+"-"+("0"+(d.getMonth()+1)).slice(-2)+"-"+("0"+d.getDate()).slice(-2),-1==$.inArray(s,e)&&(s=get_closest_date(d,e))==n){var c=s;null==(s=e[e.indexOf(s)+1])&&(s=c)}console.log(s),(l=$(this).find(".hotel-check-out0").pickadate().pickadate("picker")).set("disable",r),l.set("disable","flip"),l.set("select",new Date(s))}var h=$(this).find("tbody").find(".room-beds").val();$(this).find(".form-plugin-item").find(".room-buddy-hide-show").show(),"1"==h&&$(this).find(".form-plugin-item").find(".room-buddy-hide-show").hide();try{if(null==(o=parseInt(h)-1)||NaN==o||null==o||o<0)throw Error("max_buddy_select_no value is undefined")}catch(e){console.log(e),o=1}}try{init_select2($(this).find(".hotel-room-buddy"),o),null!=$(this).find(".hrp_existing_bookings").val()&&existing_booking($(this).find(".hrp_existing_bookings").val(),$(this))}catch(e){console.log(e)}})}function strdate_list_to_dateList(e){for(var t=[],i=0;i<e.length;i++)t.push(new Date(e[i]));return t}function existing_booking(e,t){try{if(console.log(e),att_bookings=JSON.parse(e),console.log(att_bookings),att_bookings.length>0){existing_booking_i=0;var i=0;t.find(".class-for-existing-booking").each(function(){var e=$(this),t=e.find(".plugin-box-id").val(),o=e.find(".uid-text-calss").val(),a=[];$(".default_date_format").val();null!=att_bookings[existing_booking_i]?(e.find("input[type='radio'][value='"+att_bookings[existing_booking_i].hotelroomid+"']").each(function(){$(this).attr("checked","checked"),e.find(".h-r-p-check-in-check-out").show();var l=$(this).closest("tr").find(".class-for-setting-existing-booking").val();$(this).hasClass("class-for-date-show")||($(this).show(),$(this).attr("name","data-hotel-b"+t+"-p-"+i+o),i++,$(this).addClass("class-for-date-show")),a[l]=JSON.parse($(this).closest("tr").find(".hrp-available-dates").val()),-1==$.inArray(att_bookings[existing_booking_i].checkin,a[l])&&a[l].push(att_bookings[existing_booking_i].checkin),-1==$.inArray(att_bookings[existing_booking_i].checkout,a[l])&&a[l].push(att_bookings[existing_booking_i].checkout),$(this).closest("tr").find(".hrp-available-dates").val(JSON.stringify(a[l]));var n,s,r=strdate_list_to_dateList(a[l]);(n=e.find(".hotel-reservation-calendar:input").first().pickadate().pickadate("picker")).set("disable",r),n.set("disable","flip"),n.set("select",new Date(att_bookings[existing_booking_i].checkin)),(s=e.find(".hotel-reservation-calendar:input").last().pickadate().pickadate("picker")).set("disable",r),s.set("disable","flip"),s.set("select",new Date(att_bookings[existing_booking_i].checkout)),"True"==e.closest(".form-plugin-hotel-reservation").find(".force_default_dates_checker").val()&&(n.stop(),e.find(".hotel-reservation-calendar:input").first().attr("readonly",!0),s.stop(),e.find(".hotel-reservation-calendar:input").last().attr("readonly",!0));var d=$(this).closest("tr").find(".room-beds").val(),c=1;if("1"!=d){for(var h=[],f=0;f<att_bookings[existing_booking_i].buddyids.length;f++){var _=new Option(att_bookings[existing_booking_i].buddyids[f].text,att_bookings[existing_booking_i].buddyids[f].id);$(this).closest(".form-plugin-list").find(".hotel-room-buddy").append(_).trigger("change"),h.push(att_bookings[existing_booking_i].buddyids[f].id),c=parseInt(d)-1}init_select2($(this).closest(".form-plugin-list").find(".hotel-room-buddy"),c),$(this).closest(".form-plugin-list").find(".hotel-room-buddy").val(h),$(this).closest(".form-plugin-list").find(".hotel-room-buddy").trigger("change"),$(this).closest(".form-plugin-list").find(".room-buddy-hide-show").show()}return!1}),existing_booking_i++):console.log("att_bookings undefined")})}}catch(e){console.log("Error: "+e+".")}}function get_closest_date(e,t){try{for(var i=[],o=0;o<t.length;o++)i.push(new Date(t[o]));var a,l=i.length,n=-new Date(0,0,0).valueOf(),s=0;for(a=0;a<i.length;++a)(s=Math.abs(i[a]-e))<n&&(l=a,n=s);e=i[l].getFullYear()+"-"+("0"+(i[l].getMonth()+1)).slice(-2)+"-"+("0"+i[l].getDate()).slice(-2)}catch(e){console.log("Exception in get_closest_date"),console.log(e)}return e}function get_hotel_resrevation_data(e){var t="True"==e.find(".require_room_selection_checker").val(),i="True"==e.find(".require_room_buddy_checker").val(),o=!0,a=0;$(".default_date_format").val();return e.find(".form-plugin-list").each(function(){var e=$(this).find(".plugin-box-id").val(),l=$(this).find(".uid-text-calss").val(),n=$(this).find(".uid-text-calss").val().replace("-u",""),s={user_id:n};console.log(n);var r=$(this).find("input[name='data-hotel-b"+e+"-p"+a+l+"']:checked").val();if("no-hotel"==r)return a++,s.hotelroomid="no-hotel",reservation_Data.push(s),!0;var d=reservation_Data.map(function(e){return e.user_id}).join(",");if(d=""==n?reservation_Data.length<1:-1==d.indexOf(n),t&&null==r&&d)return lang_hotel_validation_msg=$(".lang_require_room_selection").val(),o=!1,display_error_field($(this).find(".err-val-class")),!1;s.hotelroomid=null!=r?r:"0";try{console.log("stay_counter "+a);var c=$(this).find("input[name=hotel-check-in"+a+"_submit]").val();if(null==c&&null!=r)$(this).find(".hotel-check-in"+a).pickadate().pickadate("picker").start(),c=$(this).find("input[name=hotel-check-in"+a+"_submit]").val(),$(this).find(".hotel-check-in"+a).pickadate().pickadate("picker").stop(),$(this).find(".hotel-check-in"+a).attr("readonly",!0);else if(null==c)throw new Error("ignore hotel stay")}catch(e){return lang_hotel_validation_msg=$(".lang_date_not_set").val(),console.log(e),console.log(reservation_Data),t&&reservation_Data.length<1&&(o=!1),!1}var h=$(this).find("input[name=hotel-check-out"+a+"_submit]").val();if(null==h&&null!=r&&($(this).find(".hotel-check-out"+a).pickadate().pickadate("picker").start(),h=$(this).find("input[name=hotel-check-out"+a+"_submit]").val(),$(this).find(".hotel-check-out"+a).pickadate().pickadate("picker").stop(),$(this).find(".hotel-check-out"+a).attr("readonly",!0)),!(new Date(h)>new Date(c)))return lang_hotel_validation_msg=$(".lang_fix_date").val(),o=!1,display_error_field($(this).find(".hotel-check-out"+a).closest(".form-plugin-hotel-reservation-check-out")),!1;for(var f=reservation_Data.length;f>0;f--)if(n==reservation_Data[f-1].user_id){var _=new Date(c),u=new Date(h),g=new Date(reservation_Data[f-1].checkin),p=new Date(reservation_Data[f-1].checkout);if(_.getTime()==g.getTime())return lang_hotel_validation_msg=$(".lang_match_previous_date").val(),o=!1,display_error_field($(this).find(".hotel-check-in"+a).closest(".form-plugin-hotel-reservation-check-in")),display_error_field($(this).find(".hotel-check-out"+a).closest(".form-plugin-hotel-reservation-check-out")),!1;if(_>g){if(!(u>p))return lang_hotel_validation_msg=$(".lang_date_clash").val(),console.log("came 111"),o=!1,display_error_field($(this).find(".hotel-check-in"+a).closest(".form-plugin-hotel-reservation-check-in")),display_error_field($(this).find(".hotel-check-out"+a).closest(".form-plugin-hotel-reservation-check-out")),!1;if((p-_)/864e5>.9)return lang_hotel_validation_msg=$(".lang_date_clash").val(),console.log("came 222"),o=!1,display_error_field($(this).find(".hotel-check-in"+a).closest(".form-plugin-hotel-reservation-check-in")),display_error_field($(this).find(".hotel-check-out"+a).closest(".form-plugin-hotel-reservation-check-out")),!1}else if(_<g&&u>g)return console.log("came 333"),lang_hotel_validation_msg=$(".lang_date_clash").val(),o=!1,display_error_field($(this).find(".hotel-check-in"+a).closest(".form-plugin-hotel-reservation-check-in")),display_error_field($(this).find(".hotel-check-out"+a).closest(".form-plugin-hotel-reservation-check-out")),!1}s.checkin=c,s.checkout=h;var v=$(this).find("input[name='data-hotel-b"+e+"-p"+a+l+"']:checked").closest("tr").find(".room-beds").val(),k=$(this).find(".hotel-r-buddy"+a).val();if(i&&(null==k||null==k)&&1!=v)return lang_hotel_validation_msg=$(".lang_require_room_buddy").val(),o=!1,display_error_field($(this).find(".form-plugin-hotel-reservation-room-buddy")),!1;1!=v&&null!=k||(k=[]),s.buddyids=k,reservation_Data.push(s),a++}),console.log("reservation_Data"),console.log(reservation_Data),o}function init_select2(e,t){var i=$(".txt_input_too_short").val(),o=$(".txt_max_buddy_selected").val();e.select2({delay:500,minimumInputLength:1,placeholder:lang_select_room_buddy,tags:!0,multiple:!0,maximumSelectionLength:t,ajax:{url:base_url+"/hotel-reservation-plugin-buddy-list/",dataType:"json",type:"POST",data:function(e){return{csrfmiddlewaretoken:$("input[name=csrfmiddlewaretoken]").val(),q:e.term}}},language:{inputTooShort:function(e){return i},maximumSelected:function(e){return o.replace("{X}",e.maximum)}}})}function display_error_field(e){e.addClass("validation-failed"),e.find(".error-on-validate").text(lang_hotel_validation_msg)}$(function(){$body.on("click",".hotel-reservation-add-button",function(){$(".default_date_format").val();var e=$(this),t=parseInt($(this).closest(".form-plugin-hotel-reservation").find(".partial-data-counter").val()),i=parseInt($(this).closest(".form-plugin-hotel-reservation").find(".stay-add-remove-class-for-parial-value").last().val());if(i+1>=t)$.growl.warning({message:$(".lang_max_stay_reach").val()});else{$(".loader").show();var o=$(this).closest(".form-plugin-hotel-reservation").find(".form-plugin-intro").find(".h_r_element_page_id").val(),a=$(this).closest(".form-plugin-hotel-reservation").find(".form-plugin-intro").find(".h_r_element_box_id").val(),l=$("input[name=csrfmiddlewaretoken]").val(),n=($(this).closest(".form-plugin-hotel-reservation").find(".force_default_dates_checker").val(),"True"==$(this).closest(".form-plugin-hotel-reservation").find(".force_hotel_room_selection_checker").val()),s=JSON.parse($(this).closest(".form-plugin-hotel-reservation").find(".hrp-available-dates").val()),r=$(this).closest(".form-plugin-hotel-reservation").find(".class-for-partial-append");i++;var d=r.find(".uid-text-calss").val().replace("-u","");$.ajax({url:base_url+"/hotel-reservation-partial-alow-element/",type:"POST",data:{page_id:o,box_id:a,csrfmiddlewaretoken:l,partial_counter:i,user_id:d},success:function(t){if(t){r.append(t);var o=r.find(".hotel-check-in"+i).val(),a=r.find(".hotel-check-out"+i).val(),l=1;if(n){var d,c;o.length<1&&(o="2017-01-01"),a.length<1&&(a="2017-01-01");var h=strdate_list_to_dateList(s);if(o.length>1&&a.length>1){var f=new Date(o);if(o=f.getFullYear()+"-"+("0"+(f.getMonth()+1)).slice(-2)+"-"+("0"+f.getDate()).slice(-2),-1==$.inArray(o,s)&&(o=get_closest_date(f,s),f>new Date(o)&&(o=s[s.indexOf(o)-1])),(d=r.find(".hotel-check-in"+i).pickadate().pickadate("picker")).set("disable",h),d.set("disable","flip"),d.set("select",new Date(o)),a=(f=new Date(a)).getFullYear()+"-"+("0"+(f.getMonth()+1)).slice(-2)+"-"+("0"+f.getDate()).slice(-2),-1==$.inArray(a,s)&&(a=get_closest_date(f,s))==o){var _=a;null==(a=s[s.indexOf(o)+1])&&(a=_)}(c=r.find(".hotel-check-out"+i).pickadate().pickadate("picker")).set("disable",h),c.set("disable","flip"),c.set("select",new Date(a))}else console.log("no date found");var u=r.find(".room-beds").val();r.find(".room-buddy-hide-show").show(),"1"==u&&r.find(".room-buddy-hide-show").hide();try{if(null==(l=parseInt(u)-1)||NaN==l||null==l||l<0)throw Error("max_buddy_select_no value is undefined")}catch(e){console.log(e),l=1}}$(".lang_no_data_found").val();init_select2(r.find(".hotel-r-buddy"+i),l),e.closest(".form-plugin-hotel-reservation").find(".stay-add-remove-class-for-parial-value").val(i)}else console.log("Error to get partial allow");$(".loader").hide()}})}}),$body.on("click",".hotel-reservation-remove-button",function(){var e=parseInt($(this).closest(".form-plugin-hotel-reservation").find(".stay-add-remove-class-for-parial-value").last().val());e>0&&($(this).closest(".form-plugin-hotel-reservation").find(".class-for-partial-append").find(".form-plugin-list").last().remove(),e--,$(this).closest(".form-plugin-hotel-reservation").find(".stay-add-remove-class-for-parial-value").val(e))}),$body.on("click",".class-for-date-show",function(){$(this).closest(".form-plugin-item").find(".h-r-p-check-in-check-out").show();var e=$(this).closest("tr").find(".room-beds").val();if(0==e)return $(this).closest(".form-plugin-item").find(".room-buddy-hide-show").hide(),void $(this).closest(".form-plugin-item").find(".h-r-p-check-in-check-out").hide();$(this).closest(".form-plugin-item").find(".room-buddy-hide-show").show(),"1"==e&&$(this).closest(".form-plugin-item").find(".room-buddy-hide-show").hide();var t,i,o=JSON.parse($(this).closest("tr").find(".hrp-available-dates").val()),a=($(".default_date_format").val(),"True"==$(this).closest(".form-plugin-hotel-reservation").find(".force_default_dates_checker").val()),l=$(this).closest("tbody").find(".date-class-for-parial-value").val(),n=$(".default_checkin_date_value").val(),s=$(".default_checkout_date_value").val();n.length<1&&(n="2017-01-01"),s.length<1&&(s="2017-01-01");var r=strdate_list_to_dateList(o);if(a)n=(d=new Date(n)).getFullYear()+"-"+("0"+(d.getMonth()+1)).slice(-2)+"-"+("0"+d.getDate()).slice(-2),s=(d=new Date(s)).getFullYear()+"-"+("0"+(d.getMonth()+1)).slice(-2)+"-"+("0"+d.getDate()).slice(-2);else if(n.length>1&&s.length>1){var d=new Date(n);if(n=d.getFullYear()+"-"+("0"+(d.getMonth()+1)).slice(-2)+"-"+("0"+d.getDate()).slice(-2),-1==$.inArray(n,o)&&(n=get_closest_date(d,o),d>new Date(n)&&(n=o[o.indexOf(n)-1])),s=(d=new Date(s)).getFullYear()+"-"+("0"+(d.getMonth()+1)).slice(-2)+"-"+("0"+d.getDate()).slice(-2),-1==$.inArray(s,o)&&(s=get_closest_date(d,o))==n){var c=s;null==(s=o[o.indexOf(n)+1])&&(s=c)}}else console.log("no date found");(t=$(this).closest(".form-plugin-item").find(".hotel-check-in"+l).pickadate().pickadate("picker")).set("enable",!0),t.set("disable",r),t.set("disable","flip"),t.set("select",new Date(n)),(i=$(this).closest(".form-plugin-item").find(".hotel-check-out"+l).pickadate().pickadate("picker")).set("enable",!0),i.set("disable",r),i.set("disable","flip"),i.set("select",new Date(s)),a&&(t.stop(),$(this).closest(".form-plugin-item").find(".hotel-check-in"+l).attr("readonly",!0),i.stop(),$(this).closest(".form-plugin-item").find(".hotel-check-out"+l).attr("readonly",!0));var h=1;try{if(null==(h=parseInt(e)-1)||NaN==h||null==h||h<0)throw Error("max_buddy_select_no value is undefined")}catch(e){console.log(e),h=1}$(this).closest(".form-plugin-item").find(".hotel-r-buddy"+l).val(null),$(this).closest(".form-plugin-item").find(".hotel-r-buddy"+l).trigger("change"),init_select2($(this).closest(".form-plugin-item").find(".hotel-r-buddy"+l),h)})});